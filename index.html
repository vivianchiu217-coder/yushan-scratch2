<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é›¨å±±åˆ®åˆ®æ¨‚</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Noto+Sans+TC:wght@400;600;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Zen+Old+Mincho:wght@500;700&display=swap" rel="stylesheet">

<style>
:root{
--bg:#0b1220;
--ink:#d7e6ff;
--muted:#9fb3d1;
--accent:#86c5ff;
--danger:#ffcc66;
--border:rgba(255,255,255,.08);

--sans: "Noto Sans TC", system-ui, -apple-system, "PingFang TC", sans-serif;
--serif: "Noto Serif TC", "Noto Sans TC", serif;
--display: "Zen Old Mincho", "Noto Serif TC", serif;
}

body{
margin:0;
font-family: var(--sans);
background: radial-gradient(1200px 600px at 50% 0%, rgba(134,197,255,.12), transparent 60%),
radial-gradient(800px 500px at 90% 20%, rgba(255,204,102,.08), transparent 55%),
var(--bg);
color:var(--ink);
position: relative;
overflow-x: hidden;
}

body::before{
content:"";
position: fixed;
inset: 0;
pointer-events: none;
z-index: 0;
background-image: url("textures/stars.jpg");
background-repeat: repeat;
background-size: 520px auto;
background-position: center;
opacity: 0.22;
mix-blend-mode: screen;
filter: blur(0.4px) contrast(1.05);
}

.wrap{max-width:980px; margin:0 auto; padding:28px 16px 40px; position:relative; z-index:1;}

.title{
font-family: var(--serif);
font-weight: 900;
letter-spacing: .08em;
font-size: 34px;
margin: 0 0 8px;
text-shadow: 0 6px 18px rgba(0,0,0,.25);
}

.desc{ color:var(--muted); line-height:1.7; margin:0 0 18px; }
.descLine{display:inline-block;}
.descSans{ font-family: var(--display); font-weight:500; letter-spacing:.04em; }
.descSerif{ font-family: var(--display); font-weight:700; letter-spacing:.06em; }
.desc strong{font-weight:700;color:var(--ink);}

.panel{
background: rgba(15,26,43,.78);
border:1px solid var(--border);
border-radius:18px;
padding:16px;
box-shadow: 0 12px 30px rgba(0,0,0,.35);
}

.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px;}
.userline{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}

.tag{
display:inline-flex; align-items:center; gap:8px;
padding:6px 10px; border-radius:999px;
border:1px solid rgba(255,255,255,.12);
color:var(--muted);
font-size:12px;
font-family: var(--sans);
}

button{
appearance:none;
border:none;
background: rgba(134,197,255,.18);
color:var(--ink);
padding:10px 14px;
border-radius:12px;
font-weight:800;
cursor:pointer;
border:1px solid rgba(134,197,255,.25);
font-family: var(--sans);
letter-spacing: .01em;
transition: transform .12s ease, background .12s ease, opacity .12s ease;
}
button:hover{background: rgba(134,197,255,.25); transform: translateY(-1px);}
button:disabled{opacity:.6; cursor:not-allowed; transform:none;}

.ghost{
background: transparent;
border:1px solid rgba(255,255,255,.14);
color:var(--muted);
font-weight:700;
}

.pill{
padding:6px 10px;
border-radius:999px;
background: rgba(255,255,255,.06);
border:1px solid rgba(255,255,255,.10);
color: var(--muted);
font-size:12px;
font-family: var(--sans);
}

.warn{
margin-top:10px;
padding:10px 12px;
border-radius:14px;
border:1px solid rgba(255,204,102,.25);
background: rgba(255,204,102,.08);
color: rgba(255,204,102,.95);
font-size:12px;
line-height:1.6;
display:none;
white-space: pre-wrap;
font-family: var(--sans);
}

.screen{ display:none; }
.screen.active{ display:block; }

.screenTitle{
margin: 0 0 10px;
font-size: 15px;
color: var(--muted);
font-weight:700;
font-family: var(--serif);
letter-spacing:.04em;
}

.scratchWrap{
position:relative;
width:100%;
aspect-ratio: 16/10;
border-radius:14px;
overflow:hidden;
border:1px solid rgba(255,255,255,.06);
background:#ffffff;
touch-action:none;
}

canvas{
position:absolute;
inset:0;
width:100%;
height:100%;
display:block;
}

.hint{font-size:12px; color:rgba(159,179,209,.85); margin-top:8px; font-family: var(--sans);}

.navRow{
display:flex;
justify-content: flex-end;
gap:10px;
flex-wrap:wrap;
margin-top:14px;
}

.resultGrid{
margin-top:14px;
border-top:1px dashed rgba(255,255,255,.14);
padding-top:14px;
display:grid;
grid-template-columns: 1.2fr .8fr;
gap:12px;
}
@media (max-width: 880px){ .resultGrid{grid-template-columns: 1fr;} }

.box{
background: rgba(0,0,0,.18);
border:1px solid rgba(255,255,255,.08);
border-radius:16px;
padding:12px;
}

.big{font-size:18px; font-weight:900; margin:8px 0 6px; font-family: var(--serif);}
.small{font-size:12px; color:var(--muted); line-height:1.6; font-family: var(--sans);}

.note{
margin-top:10px;
padding:10px 12px;
border-radius:14px;
border:1px solid rgba(134,197,255,.18);
background: rgba(134,197,255,.06);
color: rgba(215,230,255,.92);
font-size:12px;
line-height:1.6;
}

.code{
font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
font-weight:900;
letter-spacing:.08em;
color:#0b1220;
background: var(--danger);
display:inline-block;
padding:10px 12px;
border-radius:10px;
margin-top:8px;
}

a{ color: var(--accent); text-decoration: none; }
a:hover{ text-decoration: underline; }

.startBtn{
width: 100%;
padding: 14px 16px;
border-radius: 14px;
font-size: 15px;
letter-spacing: .06em;
background: linear-gradient(90deg, rgba(134,197,255,.22), rgba(255,204,102,.16));
border: 1px solid rgba(255,255,255,.14);
box-shadow: 0 12px 30px rgba(0,0,0,.28);
}
.startBtn:hover{
transform: translateY(-1px);
background: linear-gradient(90deg, rgba(134,197,255,.28), rgba(255,204,102,.22));
}

#homeResultBlock{ display:none; }

/* âœ… è®“ä¸‰å¼µè®Šæˆä¸€æ ¼ä¸€æ ¼å¡ç‰‡ */
.scratchCol{ display:grid; gap:16px; }
.scratchCard{
background: rgba(0,0,0,.18);
border:1px solid rgba(255,255,255,.08);
border-radius:16px;
padding:12px;
}
.stageTitle{
margin: 2px 0 10px;
font-size: 15px;
color: var(--muted);
font-weight:700;
font-family: var(--serif);
letter-spacing:.04em;
}
</style>
</head>

<body>
<div class="wrap">
<h1 class="title">é›¨å±±æ˜¥æ—¥ç´ç¦ãƒ»åˆ®åˆ®æ¨‚</h1>
<p class="desc">
<span class="descLine descSans">ä¸‰é—œåˆ®åˆ®å¡ï¼šæ¯ä¸€å¼µåˆ®é–‹å¾Œæ‰æœƒå‡ºç¾è‡ªç„¶å°è¨˜ã€‚</span><br/>
<span class="descLine descSerif">ä¸‰å¼µå°è¨˜å®Œå…¨ç›¸åŒ â†’ éš¨æ©Ÿç²å¾—çé …ï¼›å…¶é¤˜åƒèˆ‡è€… â†’ æ˜¥ç¯€é™å®šé›»å­æ¡Œå¸ƒï¼ˆéš¨æ©Ÿ 1 æ¬¾ï¼‰ã€‚</span>
</p>

<div class="panel">
<div class="row userline">
<span class="tag" id="statusTag">ç‹€æ…‹ï¼šå°šæœªç™»å…¥</span>
<span class="tag">Gmail ç™»å…¥ãƒ»ä¸€äººä¸€å›</span>
</div>

<div class="row">
<button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥ï¼ˆPopupï¼‰</button>
<button id="logoutBtn" class="ghost" style="display:none;">ç™»å‡º</button>
<span class="pill" id="userPill" style="display:none;"></span>
</div>

<div class="warn" id="warnBox"></div>

<!-- Screen 1 -->
<section class="screen active" id="screen1">
<div class="row" style="margin-top:16px;">
<button class="startBtn" id="startBtn" disabled>è«‹å…ˆç™»å…¥å¾Œé–‹å§‹</button>
</div>

<div class="small" style="margin-top:10px;">
ç™»å…¥å¾ŒæŒ‰ä¸‹ã€ŒéŠæˆ²é–‹å§‹ã€ï¼Œå°‡åœ¨åŒä¸€é å®Œæˆä¸‰å¼µåˆ®åˆ®ä¸¦æ–¼æœ€å¾Œä¸€é è‡ªå‹•çµç®—ã€‚
</div>

<div class="resultGrid" id="homeResultBlock">
<div class="box">
<div class="tag">ä½ çš„ä¸‰æšè‡ªç„¶å°è¨˜</div>
<div class="big" id="marks">â€” / â€” / â€”</div>
<div class="small" id="explain">åˆ®å®Œä¸‰é—œå¾Œæ‰æœƒé¡¯ç¤ºå°è¨˜èˆ‡åˆ¤å®šçµæœã€‚</div>
</div>
<div class="box">
<div class="tag">çµæœ</div>
<div class="big" id="resultTitle">â€”</div>
<div id="reward"></div>
</div>
</div>
</section>

<!-- Screen 2 -->
<section class="screen" id="screen2">
<h3 class="screenTitle">åˆ®åˆ®å€ï½œä¸‰å¼µå°è¨˜</h3>

<div class="scratchCol">
<div class="scratchCard">
<div class="stageTitle">ç¬¬ä¸€é—œï½œéœ§å±¤åˆé–‹</div>
<div class="scratchWrap">
<canvas id="u1" width="800" height="500"></canvas>
<canvas id="o1" width="800" height="500"></canvas>
</div>
<div class="hint">ç”¨æ»‘é¼ /æ‰‹æŒ‡åœ¨å¡é¢ä¸Šåˆ®é–‹ã€‚</div>
</div>

<div class="scratchCard">
<div class="stageTitle">ç¬¬äºŒé—œï½œå±±é¢¨å›éŸ¿</div>
<div class="scratchWrap">
<canvas id="u2" width="800" height="500"></canvas>
<canvas id="o2" width="800" height="500"></canvas>
</div>
<div class="hint">åˆ®åˆ°å‡ºç¾åœ–é¨°å³å¯ã€‚</div>
</div>

<div class="scratchCard">
<div class="stageTitle">ç¬¬ä¸‰é—œï½œç¦è„ˆç›¸é€£</div>
<div class="scratchWrap">
<canvas id="u3" width="800" height="500"></canvas>
<canvas id="o3" width="800" height="500"></canvas>
</div>
<div class="hint">ä¸‰å¼µå®Œæˆå¾Œè§£é–çµç®—ã€‚</div>
</div>
</div>

<div class="note">æç¤ºï¼šå¦‚æœåˆ®å®Œäº†æ²’åæ‡‰ï¼Œè«‹å†å¤šåˆ®å¹¾ä¸‹æ‰èƒ½è§£é–çµç®—ã€‚</div>

<div class="navRow">
<button id="finishBtn" disabled>å®Œæˆä¸¦çµç®—</button>
</div>
</section>

<!-- Screen 3 -->
<section class="screen" id="screen3">
<h3 class="screenTitle">çµæœ</h3>

<div class="resultGrid">
<div class="box">
<div class="tag">ä½ çš„ä¸‰æšè‡ªç„¶å°è¨˜</div>
<div class="big" id="marks2">â€” / â€” / â€”</div>
<div class="small" id="explain2">â€”</div>
</div>
<div class="box">
<div class="tag">çµæœ</div>
<div class="big" id="resultTitle2">â€”</div>
<div id="reward2"></div>
</div>
</div>
</section>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import {
getAuth,
GoogleAuthProvider,
signInWithPopup,
getRedirectResult,
signOut,
onAuthStateChanged,
setPersistence,
browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import {
getFirestore,
doc,
getDoc,
runTransaction,
serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyDlXI9UVwW-O_Le_YC0JnkiSWxaHX1nKMg",
authDomain: "yushan-32a96.firebaseapp.com",
projectId: "yushan-32a96",
storageBucket: "yushan-32a96.firebasestorage.app",
messagingSenderId: "217432307296",
appId: "1:217432307296:web:81ccf752166e6adef23505",
measurementId: "G-7JKHSGLC20"
};

const REVEAL_THRESHOLD = 0.55;

// âœ… ä¸‰å€‹çï¼šå„ 15 äººï¼ˆç¸½å…±æœ€å¤š 45 ä½ä¸­çè€…ï¼‰
const PRIZES = [
{ type: "A", label: "æ¯›å·¾" },
{ type: "B", label: "è²¼ç´™" },
{ type: "C", label: "æ‰“ç«æ©Ÿ" },
];
const MAX_PER_PRIZE = 15;

const ICONS = [
{ key:"mountain", label:"å±±", src:"icons/mountain.png" },
{ key:"rain", label:"é›¨", src:"icons/rain.png" },
{ key:"fog", label:"éœ§", src:"icons/fog.png" },
{ key:"wind", label:"é¢¨", src:"icons/wind.png" },
{ key:"leaf", label:"è‘‰", src:"icons/leaf.png" },
{ key:"cloud", label:"é›²", src:"icons/cloud.png" },
];

const WALLPAPERS = [
{ id:"W1", label:"æ˜¥æ—¥æ¡Œå¸ƒ 01", url:"wallpapers/w1.png" },
{ id:"W2", label:"æ˜¥æ—¥æ¡Œå¸ƒ 02", url:"wallpapers/w2.png" },
{ id:"W3", label:"æ˜¥æ—¥æ¡Œå¸ƒ 03", url:"wallpapers/w3.png" },
];

const statusTag = document.getElementById("statusTag");
const warnBox = document.getElementById("warnBox");

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userPill = document.getElementById("userPill");

const startBtn = document.getElementById("startBtn");

const homeResultBlock = document.getElementById("homeResultBlock");
const marksEl = document.getElementById("marks");
const resultTitle = document.getElementById("resultTitle");
const rewardEl = document.getElementById("reward");
const explainEl = document.getElementById("explain");

const marksEl2 = document.getElementById("marks2");
const resultTitle2 = document.getElementById("resultTitle2");
const rewardEl2 = document.getElementById("reward2");
const explainEl2 = document.getElementById("explain2");

const screens = [
document.getElementById("screen1"),
document.getElementById("screen2"),
document.getElementById("screen3"),
];
const finishBtn = document.getElementById("finishBtn");

const u1 = document.getElementById("u1");
const u2 = document.getElementById("u2");
const u3 = document.getElementById("u3");
const o1 = document.getElementById("o1");
const o2 = document.getElementById("o2");
const o3 = document.getElementById("o3");

function showScreen(n){
screens.forEach((s,i) => s.classList.toggle("active", i === (n-1)));
window.scrollTo({ top: 0, behavior: "smooth" });
}

function showWarn(text){
warnBox.style.display = "block";
warnBox.textContent = text;
}
function clearWarn(){
warnBox.style.display = "none";
warnBox.textContent = "";
}

function setResultUI_NotLoggedIn(){
homeResultBlock.style.display = "none";
marksEl.textContent = "â€” / â€” / â€”";
resultTitle.textContent = "å°šæœªç™»å…¥";
rewardEl.innerHTML = `<div class="small">è«‹å…ˆä½¿ç”¨ Google ç™»å…¥å¾Œé–‹å§‹ã€‚</div>`;
explainEl.textContent = "ç™»å…¥å¾Œé–‹å§‹ã€‚åˆ®å®Œä¸‰é—œå¾Œæ‰æœƒé¡¯ç¤ºå°è¨˜èˆ‡åˆ¤å®šçµæœã€‚";

marksEl2.textContent = "â€” / â€” / â€”";
resultTitle2.textContent = "â€”";
rewardEl2.innerHTML = "";
explainEl2.textContent = "â€”";
}

function showAuthError(e){
const code = e?.code || "ï¼ˆç„¡ codeï¼‰";
const msg = e?.message || String(e);
let hint = "";
if (code === "auth/unauthorized-domain") {
hint = "è§£æ³•ï¼šFirebase â†’ Authentication â†’ Settings â†’ Authorized domains åŠ ä¸Šä½ çš„ç¶²åŸŸï¼ˆå« wwwï¼‰";
} else if (code === "auth/operation-not-allowed") {
hint = "è§£æ³•ï¼šFirebase â†’ Authentication â†’ Sign-in method â†’ Google â†’ Enable";
} else if (code === "auth/popup-blocked") {
hint = "è§£æ³•ï¼šç€è¦½å™¨æ“‹ popupï¼Œè«‹å…è¨±å½ˆçª—ã€‚";
}
showWarn(`ç™»å…¥å¤±æ•—ï¼š${code}\n${msg}\n\n${hint}`);
}

let app, auth, db;
try{
app = initializeApp(firebaseConfig);
auth = getAuth(app);
db = getFirestore(app);
try { await setPersistence(auth, browserLocalPersistence); } catch {}
}catch(e){
console.error(e);
statusTag.textContent = "ç‹€æ…‹ï¼šFirebase åˆå§‹åŒ–å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰";
showWarn("Firebase åˆå§‹åŒ–å¤±æ•—ã€‚è«‹ç”¨ Chrome â†’ é–‹ç™¼äººå“¡å·¥å…· â†’ Console çœ‹ç´…å­—ã€‚");
}

// ===== Scratch rendering =====
function randInt(n){ return Math.floor(Math.random() * n); }
function pickIcon(){ return ICONS[randInt(ICONS.length)]; }

const ASSET_VERSION = "v12"; // æƒ³æ¸…å¿«å–å°±æ”¹é€™å€‹æ•¸å­—

function loadImage(src){
return new Promise((resolve, reject) => {
const img = new Image();
img.onload = () => resolve(img);
img.onerror = () => reject(new Error("Image load failed: " + src));
img.src = src + "?v=" + ASSET_VERSION;
});
}

async function setUnder(underCanvas, fallbackLabel, icon){
const ctx = underCanvas.getContext("2d");
const w = underCanvas.width, h = underCanvas.height;
ctx.clearRect(0,0,w,h);
ctx.fillStyle = "#ffffff";
ctx.fillRect(0,0,w,h);

try{
const img = await loadImage(icon.src);
const pad = 90;
const bw = w - pad*2;
const bh = h - pad*2;
const ratio = Math.min(bw/img.width, bh/img.height);
const iw = img.width * ratio;
const ih = img.height * ratio;
const ix = (w - iw)/2;
const iy = (h - ih)/2;

ctx.globalAlpha = 1;
ctx.drawImage(img, ix, iy, iw, ih);
}catch(err){
console.warn(err);
showWarn("åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼š\n" + err.message + "\n\nè«‹ç¢ºèª icons/ è³‡æ–™å¤¾æœ‰ä¸Šå‚³ä¸”æª”åå¤§å°å¯«å®Œå…¨ä¸€è‡´ã€‚");
ctx.fillStyle = "rgba(15,26,43,.55)";
ctx.font = "900 120px 'Noto Sans TC', system-ui, -apple-system, sans-serif";
ctx.textAlign = "center";
ctx.textBaseline = "middle";
ctx.fillText(fallbackLabel, w/2, h/2);
}
}

function paintOverlay(overlayCanvas){
const ctx = overlayCanvas.getContext("2d", { willReadFrequently:true });
const w = overlayCanvas.width, h = overlayCanvas.height;

ctx.save();
ctx.globalCompositeOperation = "source-over";
ctx.fillStyle = "#ffffff";
ctx.fillRect(0,0,w,h);

ctx.fillStyle = "rgba(15,26,43,0.70)";
ctx.font = "900 44px 'Noto Serif TC', 'Noto Sans TC', system-ui, -apple-system, sans-serif";
ctx.textAlign = "center";
ctx.textBaseline = "middle";
ctx.fillText("åˆ®é–‹æ­¤è™•", w/2, h/2);
ctx.restore();
}

class ScratchOverlay{
constructor(overlayCanvas, onDone){
this.c = overlayCanvas;
this.ctx = overlayCanvas.getContext("2d", { willReadFrequently:true });
this.isDone = false;
this.down = false;
this.brush = 55;
this.onDone = onDone;

paintOverlay(this.c);
this.bind();
}

bind(){
const c = this.c;
const getPos = (e) => {
const rect = c.getBoundingClientRect();
const x = (e.clientX - rect.left) * (c.width / rect.width);
const y = (e.clientY - rect.top) * (c.height / rect.height);
return {x,y};
};

const scratchAt = (x,y) => {
if (this.isDone) return;
const ctx = this.ctx;

ctx.save();
ctx.globalCompositeOperation = "destination-out";

const g = ctx.createRadialGradient(x, y, 0, x, y, this.brush);
g.addColorStop(0, "rgba(0,0,0,1)");
g.addColorStop(0.7, "rgba(0,0,0,0.55)");
g.addColorStop(1, "rgba(0,0,0,0)");

ctx.fillStyle = g;
ctx.beginPath();
ctx.arc(x, y, this.brush, 0, Math.PI * 2);
ctx.fill();

ctx.restore();
};

c.addEventListener("pointerdown", (e) => {
e.preventDefault();
this.down = true;
c.setPointerCapture(e.pointerId);
const {x,y} = getPos(e);
scratchAt(x,y);
});

c.addEventListener("pointermove", (e) => {
if (!this.down) return;
e.preventDefault();
const {x,y} = getPos(e);
scratchAt(x,y);
});

c.addEventListener("pointerup", (e) => {
if (!this.down) return;
e.preventDefault();
this.down = false;
this.checkDone();
});

c.addEventListener("pointercancel", () => {
this.down = false;
});
}

checkDone(){
const w = this.c.width, h = this.c.height;
const data = this.ctx.getImageData(0,0,w,h).data;

let cleared = 0;
const total = w*h;
for(let i=3;i<data.length;i+=4){
if (data[i] < 10) cleared++;
}

if (!this.isDone && cleared/total >= REVEAL_THRESHOLD){
this.isDone = true;
if (typeof this.onDone === "function") this.onDone();
}
}
}

async function generateMarksFromServer(user){

const campaignRef = doc(db, "meta", "campaign");
const TOTAL_LIMIT = 45; // ç¸½ä¸­çä¸Šé™
const WIN_RATE = 0.03; // 3% æ©Ÿç‡

return await runTransaction(db, async (tx)=>{

const campSnap = await tx.get(campaignRef);
const camp = campSnap.exists()? campSnap.data():{};
const totalWinners = camp.totalWinners || 0;
const prizeCounts = camp.prizeCounts || {};

let winGranted = false;
let pickedPrize = null;

// âœ… åªæœ‰ç¸½åé¡æ²’æ»¿æ‰å¯èƒ½ä¸­
if(totalWinners < TOTAL_LIMIT){

if(Math.random() < WIN_RATE){

// æ‰¾é‚„æœ‰åé¡çš„çé …
const available = PRIZES.filter(p=>(prizeCounts[p.type]||0)<MAX_PER_PRIZE);

if(available.length > 0){

pickedPrize = available[Math.floor(Math.random()*available.length)];
winGranted = true;

// ğŸ”’ åœ¨ transaction è£¡é–åé¡
tx.set(campaignRef,{
prizeCounts:{
...prizeCounts,
[pickedPrize.type]:(prizeCounts[pickedPrize.type]||0)+1
},
totalWinners: totalWinners+1
},{merge:true});
}
}
}

// ===== æ±ºå®šç•«é¢è¦é¡¯ç¤ºçš„ marks =====

if(winGranted){

const icon = pickIcon();

return {
marks:[icon,icon,icon],
win:true,
prize:pickedPrize
};
}

// æ²’ä¸­ or åé¡æ»¿ â†’ å¼·åˆ¶ä¸‰å€‹ä¸åŒ
let a = pickIcon(), b = pickIcon(), c = pickIcon();
while (a.key===b.key && b.key===c.key){
b = pickIcon();
c = pickIcon();
}

return {
marks:[a,b,c],
win:false
};

});
}

async function finalizeWithServer({ user, marks }){
const playRef = doc(db, "plays", user.uid);

const out = await runTransaction(db, async (tx) => {

const playSnap = await tx.get(playRef);
if (playSnap.exists()) {
return { alreadyPlayed: true, ...playSnap.data() };
}

const gameResult = window._currentGameResult;

let result = "LOSE";
let winnerGranted = false;
let wallpaperId = null;
let prizeType = null;
let prizeLabel = null;

if(gameResult?.win){

result = "WIN";
winnerGranted = true;
prizeType = gameResult.prize.type;
prizeLabel = gameResult.prize.label;

}else{

wallpaperId = WALLPAPERS[
Math.floor(Math.random() * WALLPAPERS.length)
].id;

}

const payload = {
email: user.email || null,
playedAt: serverTimestamp(),
result,
winnerGranted,
wallpaperId,
prizeType,
prizeLabel,
markKeys: marks.map(m => m.key),
};

tx.set(playRef, payload);

return { alreadyPlayed: false, ...payload };

});

return out;
}

function renderResultFromPlayDoc(playDocData){
const markLabels = (playDocData.markKeys || []).map(k => (ICONS.find(i=>i.key===k)?.label || "â€”"));
const markText = (markLabels.length === 3) ? `${markLabels[0]} / ${markLabels[1]} / ${markLabels[2]}` : "â€” / â€” / â€”";

marksEl.textContent = markText;
marksEl2.textContent = markText;

if (playDocData.result === "WIN" && playDocData.winnerGranted) {
const title = "ğŸ‰ æ­å–œä¸­ç";
const explain = "ä¸‰é—œå°è¨˜å®Œå…¨ç›¸åŒï¼Œé›¨å±±å›æ‡‰ä½ çš„ç¦æ°£ã€‚";
const prizeText = playDocData.prizeLabel || "çé …";

const html = `
<div class="small">ä½ æŠ½åˆ°ï¼š<strong>${prizeText}</strong></div>
<div class="code">${prizeText}</div>
<div class="small">ï¼ˆè«‹ç§è¨Šå®˜æ–¹å¸³è™Ÿé ˜å–ï¼‰</div>
`;

resultTitle.textContent = title;
explainEl.textContent = explain;
rewardEl.innerHTML = html;

resultTitle2.textContent = title;
explainEl2.textContent = explain;
rewardEl2.innerHTML = html;
return;
}

// åƒèˆ‡ç¦®
const title = "ğŸŒ¿ æ˜¥æ—¥ç´ç¦ï½œåƒèˆ‡ç¦®";
const explain = "é›–æœªç›¸åˆï¼ˆæˆ–çé …åé¡å·²æ»¿ï¼‰ï¼Œä½†å±±é¢¨ä»ç‚ºä½ è€Œä¾†ã€‚";
const wp = WALLPAPERS.find(w => w.id === playDocData.wallpaperId) || WALLPAPERS[0];
const html = `
<div class="small">ä½ å·²ç²å¾—ï¼šé›¨å±±æ˜¥ç¯€é™å®šé›»å­æ¡Œå¸ƒï¼ˆéš¨æ©Ÿ 1 æ¬¾ï¼‰</div>
<div class="small" style="margin-top:8px;">
<a href="${wp.url}" download>ä¸‹è¼‰ï¼š${wp.label}</a>
</div>
`;

resultTitle.textContent = title;
explainEl.textContent = explain;
rewardEl.innerHTML = html;

resultTitle2.textContent = title;
explainEl2.textContent = explain;
rewardEl2.innerHTML = html;
}

function withTimeout(promise, ms){
return new Promise((resolve, reject) => {
const t = setTimeout(() => reject(new Error("è®€å– plays é€¾æ™‚")), ms);
promise.then(v => { clearTimeout(t); resolve(v); })
.catch(e => { clearTimeout(t); reject(e); });
});
}

async function applyMarksToBoardFromKeys(markKeys){
const icons = (markKeys || []).map(k => ICONS.find(i => i.key === k)).filter(Boolean);
if (icons.length !== 3) return;

await setUnder(u1, "1", icons[0]);
await setUnder(u2, "2", icons[1]);
await setUnder(u3, "3", icons[2]);
paintOverlay(o1); paintOverlay(o2); paintOverlay(o3);
}

function resetNavButtons(){
finishBtn.disabled = true;
}

let currentUser = null;
let marks = null;
let overlay1 = null, overlay2 = null, overlay3 = null;
let doneCount = 0;

async function initBoardForNewGame(){
const result = await generateMarksFromServer(currentUser);
marks = result.marks;
window._currentGameResult = result;

await setUnder(u1, "1", marks[0]);
await setUnder(u2, "2", marks[1]);
await setUnder(u3, "3", marks[2]);

paintOverlay(o1);
paintOverlay(o2);
paintOverlay(o3);

resetNavButtons();
doneCount = 0;

const onOneDone = () => {
doneCount++;
statusTag.textContent = `ç‹€æ…‹ï¼šå·²å®Œæˆ ${doneCount}/3`;
if (doneCount >= 3) {
finishBtn.disabled = false;
statusTag.textContent = "ç‹€æ…‹ï¼šå·²å®Œæˆ 3/3ï¼ˆå¯çµç®—ï¼‰";
}
};

overlay1 = new ScratchOverlay(o1, onOneDone);
overlay2 = new ScratchOverlay(o2, onOneDone);
overlay3 = new ScratchOverlay(o3, onOneDone);
}

async function startGameFlow(){
if (!currentUser) return;

clearWarn();
homeResultBlock.style.display = "none";
statusTag.textContent = "ç‹€æ…‹ï¼šé€²è¡Œä¸­ï¼ˆåˆ®å®Œä¸‰å¼µå¯çµç®—ï¼‰";

try{
await initBoardForNewGame();
showScreen(2);
}catch(err){
console.error(err);
showWarn("é–‹å§‹å¤±æ•—ï¼š\n" + (err?.message || err) + "\n\nå¸¸è¦‹åŸå› ï¼šicons/ æˆ– wallpapers/ è·¯å¾‘/å¤§å°å¯«éŒ¯ã€‚");
statusTag.textContent = "ç‹€æ…‹ï¼šç™¼ç”ŸéŒ¯èª¤ï¼ˆè«‹é‡æ–°æ•´ç†å†è©¦ï¼‰";
}
}

async function finalizeAndShowResult(){
if (!currentUser || !marks) return;

statusTag.textContent = "ç‹€æ…‹ï¼šçµç®—ä¸­â€¦";

const localMarkText = `${marks[0].label} / ${marks[1].label} / ${marks[2].label}`;
marksEl.textContent = localMarkText;
marksEl2.textContent = localMarkText;

let out;
try{
out = await finalizeWithServer({ user: currentUser, marks });
}catch(err){
console.error(err);
statusTag.textContent = "ç‹€æ…‹ï¼šç™¼ç”ŸéŒ¯èª¤ï¼ˆè«‹é‡æ–°æ•´ç†å†è©¦ï¼‰";
resultTitle2.textContent = "âš ï¸ éŒ¯èª¤";
rewardEl2.innerHTML = `<div class="small">å¾Œç«¯å¯«å…¥å¤±æ•—ï¼š${err?.message || err}</div>`;
showScreen(3);
return;
}

renderResultFromPlayDoc(out);
statusTag.textContent = "ç‹€æ…‹ï¼šå·²å®Œæˆï¼ˆGmail ä¸€äººä¸€å›ï¼‰";

startBtn.textContent = "å·²å®Œæˆï¼ˆä¸å¯å†ç©ï¼‰";
startBtn.disabled = true;

showScreen(3);
}

// ===== Buttons =====
loginBtn.addEventListener("click", async () => {
clearWarn();
loginBtn.disabled = true;
try {
const provider = new GoogleAuthProvider();
await signInWithPopup(auth, provider);
} catch (e) {
console.error(e);
showAuthError(e);
} finally {
loginBtn.disabled = false;
}
});

logoutBtn.addEventListener("click", async () => {
clearWarn();
try { await signOut(auth); }
catch (e) { console.error(e); showWarn("ç™»å‡ºå¤±æ•—ï¼š" + (e?.message || e)); }
});

try { await getRedirectResult(auth); } catch(e) {}

startBtn.addEventListener("click", startGameFlow);
finishBtn.addEventListener("click", finalizeAndShowResult);

// ===== Auth state =====
onAuthStateChanged(auth, async (user) => {
currentUser = user || null;
resetNavButtons();

if (!user){
loginBtn.style.display = "";
logoutBtn.style.display = "none";
userPill.style.display = "none";
userPill.textContent = "";

statusTag.textContent = "ç‹€æ…‹ï¼šå°šæœªç™»å…¥";
setResultUI_NotLoggedIn();

startBtn.disabled = true;
startBtn.textContent = "è«‹å…ˆç™»å…¥å¾Œé–‹å§‹";
showScreen(1);
return;
}

loginBtn.style.display = "none";
logoutBtn.style.display = "";
userPill.style.display = "";
userPill.textContent = user.email ? `å·²ç™»å…¥ï¼š${user.email}` : "å·²ç™»å…¥";
clearWarn();

startBtn.disabled = false;
startBtn.textContent = "éŠæˆ²é–‹å§‹";
homeResultBlock.style.display = "none";
statusTag.textContent = "ç‹€æ…‹ï¼šå·²ç™»å…¥ï¼ˆè®€å–è³‡æ–™ä¸­â€¦ï¼‰";

try{
const playRef = doc(db, "plays", user.uid);
const snap = await withTimeout(getDoc(playRef), 6000);

if (snap.exists()){
const data = snap.data();

await applyMarksToBoardFromKeys(data.markKeys);
renderResultFromPlayDoc(data);

statusTag.textContent = "ç‹€æ…‹ï¼šå·²å®Œæˆï¼ˆGmail ä¸€äººä¸€å›ï¼‰";
startBtn.textContent = "å·²å®Œæˆï¼ˆä¸å¯å†ç©ï¼‰";
startBtn.disabled = true;

showScreen(3);
return;
}
}catch(err){
console.error(err);
showWarn(
"æé†’ï¼šç›®å‰è®€å– Firestore æœ‰å•é¡Œï¼ˆå¯èƒ½æ˜¯ Rules / API / æ¬Šé™ï¼‰ã€‚\n" +
"æˆ‘ä»è®“ä½ å¯ä»¥é–‹å§‹åˆ®åˆ®æ¸¬è©¦ã€‚\n\néŒ¯èª¤ï¼š" + (err?.message || err)
);
}

statusTag.textContent = "ç‹€æ…‹ï¼šå·²ç™»å…¥ï¼ˆå¯é–‹å§‹ï¼‰";
showScreen(1);
});

// åˆå§‹ UI
statusTag.textContent = "ç‹€æ…‹ï¼šå°šæœªç™»å…¥";
setResultUI_NotLoggedIn();
showScreen(1);
</script>
</body>
</html>